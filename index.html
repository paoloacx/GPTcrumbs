<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breadcrumbs Timeline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        /* (kept the same styles as original for brevity) */
        /* ... */
    </style>
</head>
<body>
    <!-- unchanged HTML structure (kept for compatibility with UI) -->

    <!-- --- APP --- -->

    <script>
        // -------------------------
        // Small security + stability improvements applied to original file
        // Source file reviewed: index.html uploaded by user. ÓàÄfileciteÓàÇturn0file0ÓàÅ
        // -------------------------

        // Firebase Configuration (same keys as original; consider moving API keys to server-side or restricting usage in the Firebase console)
        const firebaseConfig = {
            apiKey: "AIzaSyAb-MLu8atl5hruOPLDhgftjkjc_1M2038",
            authDomain: "breadcrumbs-8b59e.firebaseapp.com",
            projectId: "breadcrumbs-8b59e",
            storageBucket: "breadcrumbs-8b59e.firebasestorage.app",
            messagingSenderId: "912286191427",
            appId: "1:912286191427:web:e78b665df6a6ff6d8529f6",
            measurementId: "G-GZYTDYNSRB"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Note: WEATHER_API_KEY is exposed in client code. If you don't want it public, proxy requests from your server.
        const WEATHER_API_KEY = '317f7bcb07cf05e2c6265176c502a4bb';

        // App state
        let currentUser = null;
        let isOfflineMode = false;

        let entries = [];
        let currentImages = [];
        let currentAudio = null;
        let currentCoords = null;
        let editingEntryId = null;
        let selectedMood = null;
        let selectedDuration = null;
        let selectedActivity = null;

        let mediaRecorder = null;
        let audioChunks = [];

        // Settings
        let timeDurations = [15, 30, 60, 120, 180];
        let timeActivities = ['Reading', 'Sports', 'Work', 'Cleaning', 'Errands'];
        let trackItems = {
            meals: ['üç≥ Breakfast', 'ü•ó Lunch', 'üçΩÔ∏è Dinner', '‚òï Snack'],
            tasks: ['üíä Medicine', 'üíß Water', 'üö∂ Walk', 'üìû Call']
        };

        const defaultMoods = [
            { emoji: 'üòä', label: 'Happy' },
            { emoji: 'üò¢', label: 'Sad' },
            { emoji: 'üò°', label: 'Angry' },
            { emoji: 'üò∞', label: 'Anxious' },
            { emoji: 'üò¥', label: 'Tired' }
        ];

        let moods = [...defaultMoods];

        // ------- Utility helpers -------
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Manage Leaflet map instances per container to avoid duplicate map errors
        function removeLeafletMap(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (container._leaflet_map) {
                try { container._leaflet_map.remove(); } catch (e) { /* ignore */ }
                container._leaflet_map = null;
            }
        }

        function createLeafletMap(containerId, lat, lon, zoom = 13) {
            removeLeafletMap(containerId);
            const map = L.map(containerId).setView([lat, lon], zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            L.marker([lat, lon]).addTo(map);
            const container = document.getElementById(containerId);
            container._leaflet_map = map;
            setTimeout(() => map.invalidateSize(), 100);
            return map;
        }

        // ----------------- Storage helpers -----------------
        function loadSettings() {
            const savedDurations = localStorage.getItem('time-durations');
            const savedActivities = localStorage.getItem('time-activities');
            const savedTrackItems = localStorage.getItem('track-items');
            if (savedDurations) timeDurations = JSON.parse(savedDurations);
            if (savedActivities) timeActivities = JSON.parse(savedActivities);
            if (savedTrackItems) trackItems = JSON.parse(savedTrackItems);
        }

        function saveSettingsToStorage() {
            localStorage.setItem('time-durations', JSON.stringify(timeDurations));
            localStorage.setItem('time-activities', JSON.stringify(timeActivities));
            localStorage.setItem('track-items', JSON.stringify(trackItems));
        }

        function loadMoodConfig() {
            const saved = localStorage.getItem('mood-config');
            if (saved) moods = JSON.parse(saved);
        }

        function saveMoodConfigData() {
            localStorage.setItem('mood-config', JSON.stringify(moods));
        }

        function loadData() {
            const saved = localStorage.getItem('timeline-entries');
            if (saved) entries = JSON.parse(saved);
            renderTimeline();
        }

        function saveData() {
            localStorage.setItem('timeline-entries', JSON.stringify(entries));
            if (!isOfflineMode && currentUser) {
                // attempt push to firebase but do not block local persistence
                saveDataToFirebase().catch(() => {});
            }
        }

        async function saveDataToFirebase() {
            if (!currentUser) return;
            // Use individual writes instead of large batch to reduce failure blast radius
            try {
                await Promise.all(entries.map(entry => {
                    const docRef = db.collection('users').doc(currentUser.uid).collection('entries').doc(String(entry.id));
                    return docRef.set(entry);
                }));
                updateSyncStatus('online');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                updateSyncStatus('offline');
                throw error;
            }
        }

        // ----------------- Auth and app boot -----------------
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                showMainApp();
                updateSyncStatus('online');
                loadDataFromFirebase();
            }
        });

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                console.error('Google sign-in error:', error);
                alert('Sign in error: ' + error.message);
            });
        }

        function signOutUser() {
            if (confirm('Sign out?')) {
                auth.signOut().then(() => location.reload());
            }
        }

        function continueOffline() {
            isOfflineMode = true;
            showMainApp();
            updateSyncStatus('offline');
            loadData();
        }

        function showMainApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            if (currentUser) {
                const email = currentUser.email || '';
                const shortEmail = email.length > 20 ? email.substring(0, 17) + '...' : email;
                document.getElementById('user-email-short').textContent = 'üë§ ' + shortEmail;
                document.getElementById('user-avatar').style.display = 'block';
            }
        }

        function updateSyncStatus(status) {
            const statusEl = document.getElementById('sync-status');
            if (!statusEl) return;
            if (status === 'online') {
                statusEl.textContent = '‚óè Online';
                statusEl.style.color = '#00ff00';
            } else if (status === 'syncing') {
                statusEl.textContent = '‚Üª Syncing...';
                statusEl.style.color = '#ffff00';
            } else {
                statusEl.textContent = '‚óè Offline';
                statusEl.style.color = '#ff0000';
            }
        }

        async function loadDataFromFirebase() {
            if (!currentUser) return;
            updateSyncStatus('syncing');
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('entries').orderBy('timestamp', 'desc').get();
                entries = [];
                snapshot.forEach((doc) => entries.push({ id: doc.id, ...doc.data() }));
                renderTimeline();
                updateSyncStatus('online');
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                updateSyncStatus('offline');
                loadData();
            }
        }

        // ----------------- Maps, weather, media -----------------
        function getGPS() {
            const btn = document.getElementById('gps-btn');
            const locationInput = document.getElementById('location-input');
            btn.textContent = '‚è≥ Searching...';
            btn.disabled = true;

            if (!navigator.geolocation) {
                alert('Geolocation not available');
                btn.textContent = 'üåç Use GPS';
                btn.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    currentCoords = { lat, lon };
                    showMiniMap(lat, lon, 'form-map');
                    getWeather(lat, lon);
                    btn.textContent = 'üåç GPS OK';
                    btn.disabled = false;
                },
                (error) => {
                    console.error('GPS Error:', error);
                    alert('Error getting location: ' + error.message);
                    btn.textContent = 'üåç Use GPS';
                    btn.disabled = false;
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function getWeather(lat, lon) {
            const weatherInput = document.getElementById('weather-input');
            const locationInput = document.getElementById('location-input');
            weatherInput.value = '‚è≥ Getting weather...';
            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=en`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Weather API returned ' + response.status);
                const data = await response.json();
                const temp = Math.round(data.main.temp);
                const description = data.weather[0].description;
                const emoji = getWeatherEmoji(data.weather[0].id);
                const city = data.name || '';
                weatherInput.value = `${emoji} ${description}, ${temp}¬∞C in ${city}`;
                if (city) locationInput.value = city;
            } catch (error) {
                console.error('Error getting weather:', error);
                weatherInput.value = '';
                alert('Could not get weather data: ' + error.message);
            }
        }

        function getWeatherEmoji(code) {
            if (code >= 200 && code < 300) return '‚õàÔ∏è';
            if (code >= 300 && code < 400) return 'üå¶Ô∏è';
            if (code >= 500 && code < 600) return 'üåßÔ∏è';
            if (code >= 600 && code < 700) return '‚ùÑÔ∏è';
            if (code >= 700 && code < 800) return 'üå´Ô∏è';
            if (code === 800) return '‚òÄÔ∏è';
            if (code > 800) return '‚òÅÔ∏è';
            return 'üå§Ô∏è';
        }

        function showMiniMap(lat, lon, containerId) {
            const mapContainer = document.getElementById(containerId);
            if (!mapContainer) return;
            mapContainer.style.display = 'block';
            createLeafletMap(containerId, lat, lon, 13);
        }

        // ----------------- Images and audio -----------------
        function handleImages(event) {
            const files = Array.from(event.target.files || []);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width; let height = img.height; const maxSize = 800;
                        if (width > height && width > maxSize) { height = (height * maxSize) / width; width = maxSize; }
                        else if (height > maxSize) { width = (width * maxSize) / height; height = maxSize; }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const resizedImage = canvas.toDataURL('image/jpeg', 0.8);
                        currentImages.push(resizedImage);
                        renderImagePreviews();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => { currentAudio = reader.result; renderAudioPreview(); };
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.start();
                document.getElementById('record-btn').disabled = true;
                document.getElementById('stop-record-btn').disabled = false;
                document.querySelector('.audio-recorder').classList.add('recording');
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('record-btn').disabled = false;
                document.getElementById('stop-record-btn').disabled = true;
                document.querySelector('.audio-recorder').classList.remove('recording');
            }
        }

        function renderImagePreviews() {
            const container = document.getElementById('image-previews');
            container.innerHTML = currentImages.map((img, idx) => `
                <div class="image-preview">
                    <img src="${img}" alt="">
                    <div class="image-remove" onclick="removeImage(${idx})">‚úï</div>
                </div>
            `).join('');
        }

        function renderAudioPreview() {
            const container = document.getElementById('audio-preview');
            if (currentAudio) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                        <audio controls style="flex: 1;"><source src="${currentAudio}" type="audio/webm"></audio>
                        <button class="mac-button" onclick="removeAudio()" style="padding: 4px 8px;">‚úï</button>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        function removeImage(index) { currentImages.splice(index, 1); renderImagePreviews(); }
        function removeAudio() { currentAudio = null; renderAudioPreview(); }

        // ----------------- Moods UI -----------------
        function renderMoodSelector() {
            const container = document.getElementById('mood-selector');
            container.innerHTML = moods.map((mood, index) => `
                <div class="mood-option ${selectedMood === index ? 'selected' : ''}" onclick="selectMood(${index})">
                    ${escapeHtml(mood.emoji)}
                    <span class="mood-label">${escapeHtml(mood.label)}</span>
                </div>
            `).join('');
        }
        function selectMood(index) { selectedMood = index; renderMoodSelector(); }

        function toggleMoodConfig() {
            const panel = document.getElementById('mood-config');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) renderMoodConfig();
        }

        function renderMoodConfig() {
            const container = document.getElementById('mood-config-list');
            container.innerHTML = moods.map((mood, index) => `
                <div class="config-item">
                    <input type="text" value="${escapeHtml(mood.emoji)}" id="mood-emoji-${index}" maxlength="2">
                    <input type="text" value="${escapeHtml(mood.label)}" id="mood-label-${index}" placeholder="Label">
                </div>
            `).join('');
        }

        function saveMoodConfig() {
            moods = moods.map((mood, index) => ({
                emoji: document.getElementById(`mood-emoji-${index}`).value || mood.emoji,
                label: document.getElementById(`mood-label-${index}`).value || mood.label
            }));
            saveMoodConfigData();
            renderMoodSelector();
            toggleMoodConfig();
            alert('‚úÖ Configuration saved');
        }

        // ----------------- Entries CRUD -----------------
        function saveEntry() {
            const note = document.getElementById('note-input').value.trim();
            if (!note) { alert('Please write a note'); return; }
            const moodData = selectedMood !== null ? moods[selectedMood] : null;

            if (editingEntryId) {
                const entryIndex = entries.findIndex(e => e.id === editingEntryId);
                if (entryIndex !== -1) {
                    entries[entryIndex] = {
                        ...entries[entryIndex],
                        note: note,
                        location: document.getElementById('location-input').value,
                        weather: document.getElementById('weather-input').value,
                        images: [...currentImages],
                        audio: currentAudio,
                        coords: currentCoords ? { ...currentCoords } : entries[entryIndex].coords,
                        mood: moodData
                    };
                }
            } else {
                const entry = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    note: note,
                    location: document.getElementById('location-input').value,
                    weather: document.getElementById('weather-input').value,
                    images: [...currentImages],
                    audio: currentAudio,
                    coords: currentCoords ? { ...currentCoords } : null,
                    mood: moodData
                };
                entries.unshift(entry);
            }

            saveData();
            renderTimeline();
            toggleForm();
        }

        function editEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            editingEntryId = id;
            document.getElementById('note-input').value = entry.note || '';
            document.getElementById('location-input').value = entry.location || '';
            document.getElementById('weather-input').value = entry.weather || '';
            currentImages = [...(entry.images || [])];
            currentAudio = entry.audio || null;
            currentCoords = entry.coords ? { ...entry.coords } : null;
            if (entry.mood) {
                const moodIndex = moods.findIndex(m => m.emoji === entry.mood.emoji && m.label === entry.mood.label);
                selectedMood = moodIndex !== -1 ? moodIndex : null;
            } else selectedMood = null;
            renderImagePreviews(); renderAudioPreview(); renderMoodSelector();
            if (entry.coords) showMiniMap(entry.coords.lat, entry.coords.lon, 'form-map');
            document.getElementById('delete-btn').classList.remove('hidden');
            document.getElementById('save-btn').textContent = 'üíæ Update';
            const formWindow = document.getElementById('form-window');
            formWindow.classList.remove('hidden');
            formWindow.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function deleteCurrentEntry() {
            if (!editingEntryId) return;
            if (confirm('Delete this entry?')) {
                entries = entries.filter(e => e.id !== editingEntryId);
                if (currentUser && !isOfflineMode) {
                    db.collection('users').doc(currentUser.uid).collection('entries').doc(String(editingEntryId)).delete().catch(console.error);
                }
                saveData(); renderTimeline(); toggleForm();
            }
        }

        // ----------------- Preview and timeline rendering (sanitized) -----------------
        function previewEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            const modal = document.getElementById('preview-modal');
            const body = document.getElementById('preview-body');
            let html = `
                <div style="margin-bottom: 16px;"><strong>Time:</strong> ${escapeHtml(formatDate(entry.timestamp))} at ${escapeHtml(formatTime(entry.timestamp))}</div>
                ${entry.mood ? `<div style="margin-bottom: 16px;"><strong>Mood:</strong> <span style="font-size: 24px;">${escapeHtml(entry.mood.emoji)}</span> ${escapeHtml(entry.mood.label)}</div>` : ''}
                <div style="margin-bottom: 16px;"><strong>Note:</strong><div style="margin-top: 8px; line-height: 1.6;">${escapeHtml(entry.note).replace(/\n/g, '<br>')}</div></div>
                ${entry.location ? `<div style="margin-bottom: 16px;"><strong>Location:</strong> ${escapeHtml(entry.location)}</div>` : ''}
                ${entry.weather ? `<div style="margin-bottom: 16px;"><strong>Weather:</strong> ${escapeHtml(entry.weather)}</div>` : ''}
                ${entry.coords ? `<div style="margin-bottom: 16px;"><strong>Map:</strong><div class="preview-map-full" id="preview-map-modal"></div></div>` : ''}
                ${entry.audio ? `<div style="margin-bottom: 16px;"><strong>Audio:</strong><audio controls style="width: 100%; margin-top: 8px;"><source src="${entry.audio}" type="audio/webm"></audio></div>` : ''}
                ${entry.images && entry.images.length > 0 ? `<div style="margin-bottom: 16px;"><strong>Images:</strong><div class="preview-images-full">${entry.images.map(img => `<img src="${img}" class="preview-image-full" onclick="window.open('${img}')">`).join('')}</div></div>` : ''}
                ${entry.isTimedActivity ? `<div style="margin-bottom: 16px;"><strong>Activity:</strong> ${escapeHtml(entry.activity)} (${escapeHtml(String(entry.duration))} minutes)</div>` : ''}
                ${entry.isSpent ? `<div style="margin-bottom: 16px;"><strong>Amount Spent:</strong> ‚Ç¨${escapeHtml(String(entry.spentAmount.toFixed(2)))}</div>` : ''}
            `;
            body.innerHTML = html;
            modal.classList.add('show');
            if (entry.coords) setTimeout(() => createLeafletMap('preview-map-modal', entry.coords.lat, entry.coords.lon, 13), 150);
        }

        function closePreview(event) {
            if (event && event.target.id !== 'preview-modal') return;
            const modal = document.getElementById('preview-modal');
            modal.classList.remove('show');
            document.getElementById('preview-body').innerHTML = '';
            // remove preview map if any
            removeLeafletMap('preview-map-modal');
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        function formatTime(timestamp) { const date = new Date(timestamp); return date.toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' }); }

        function getDayKey(timestamp) { const date = new Date(timestamp); return date.toISOString().split('T')[0]; }

        function toggleDay(dayKey) { const content = document.getElementById(`day-content-${dayKey}`); const chevron = document.getElementById(`chevron-${dayKey}`); if (content) content.classList.toggle('expanded'); if (chevron) chevron.classList.toggle('expanded'); }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            const emptyState = document.getElementById('empty-state');
            const footer = document.getElementById('footer');
            if (!container) return;
            if (entries.length === 0) { container.innerHTML = ''; if (emptyState) emptyState.classList.remove('hidden'); if (footer) footer.style.display = 'none'; return; }
            if (emptyState) emptyState.classList.add('hidden'); if (footer) footer.style.display = 'flex';

            // group entries by day and sort by timestamp desc
            const groupedByDay = {};
            entries.forEach(entry => {
                const dayKey = getDayKey(entry.timestamp);
                if (!groupedByDay[dayKey]) groupedByDay[dayKey] = [];
                groupedByDay[dayKey].push(entry);
            });
            const dayKeys = Object.keys(groupedByDay).sort((a,b) => b.localeCompare(a));

            const html = `
                <div class="timeline">
                    <div class="timeline-line"></div>
                    ${dayKeys.map(dayKey => {
                        const dayEntries = groupedByDay[dayKey];
                        const firstEntry = dayEntries[0];
                        return `
                            <div class="day-block">
                                <div class="day-header" onclick="toggleDay('${dayKey}')">
                                    <span>${escapeHtml(formatDate(firstEntry.timestamp))}</span>
                                    <span class="chevron" id="chevron-${dayKey}">‚ñº</span>
                                </div>
                                <div class="day-content" id="day-content-${dayKey}">
                                    ${dayEntries.map(entry => {
                                        const heightStyle = entry.isTimedActivity && entry.duration ? `min-height: ${Math.min(150 + entry.duration * 0.5, 300)}px;` : '';
                                        const trackClass = entry.isQuickTrack ? 'track-event' : '';
                                        // sanitize note for timeline (show plain text but keep newlines)
                                        const safeNote = escapeHtml(entry.note || '').replace(/\n/g, '<br>');
                                        return `
                                        <div class="breadcrumb-entry ${entry.isTimedActivity || entry.isSpent ? 'edit-mode' : ''} ${trackClass}" style="${heightStyle}">
                                            <button class="mac-button edit-button" onclick="editEntry(${entry.id})">‚úèÔ∏è Edit</button>
                                            <button class="mac-button preview-button" onclick="previewEntry(${entry.id})">üîç Preview</button>
                                            <div class="breadcrumb-time">‚è∞ ${escapeHtml(formatTime(entry.timestamp))} ${entry.isSpent ? `<span class="spent-badge">üí∞ ‚Ç¨${escapeHtml(String(entry.spentAmount.toFixed(2)))}</span>` : ''}</div>
                                            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px;">
                                                ${entry.mood ? `<span class="mood-display">${escapeHtml(entry.mood.emoji)}</span>` : ''}
                                                <div style="flex: 1;"><div class="breadcrumb-note" id="note-${entry.id}">${safeNote}</div>${(entry.note && entry.note.length > 150) ? `<button class="read-more-btn" id="read-more-${entry.id}" onclick="toggleReadMore(${entry.id})">Read more</button>` : ''}</div>
                                            </div>
                                            ${entry.weather || entry.location ? `<div style="font-size: 12px; color: ${entry.isQuickTrack ? '#ccc' : '#666'}; margin-bottom: 8px;">${entry.weather ? escapeHtml(entry.weather) : ''} ${entry.location ? ` ‚Ä¢ üìç ${escapeHtml(entry.location)}` : ''}</div>` : ''}
                                            ${entry.audio ? `<div style="margin-top: 12px; margin-bottom: 12px;"><audio controls style="width: 100%; max-width: 300px;"><source src="${entry.audio}" type="audio/webm"></audio></div>` : ''}
                                            <div class="breadcrumb-preview">
                                                ${entry.images && entry.images.length > 0 ? entry.images.map(img => `<img src="${img}" class="preview-image-thumb" onclick="window.open('${img}')">`).join('') : ''}
                                                ${entry.coords ? `<div class="preview-map-thumb" onclick="previewEntry(${entry.id})" style="display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px;">üó∫Ô∏è</div>` : ''}
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Read more toggle (simple height toggle)
        function toggleReadMore(id) {
            const noteEl = document.getElementById(`note-${id}`);
            const btnEl = document.getElementById(`read-more-${id}`);
            if (!noteEl || !btnEl) return;
            if (noteEl.classList.contains('expanded')) { noteEl.classList.remove('expanded'); btnEl.textContent = 'Read more'; }
            else { noteEl.classList.add('expanded'); btnEl.textContent = 'Show less'; }
        }

        // ----------------- Timer / Track / Spent -----------------
        function updateTimerOptions() {
            const container = document.getElementById('duration-selector');
            if (!container) return;
            container.innerHTML = timeDurations.map(duration => `
                <div class="duration-option" data-duration="${duration}" onclick="selectDurationFromElement(event)">${duration < 60 ? duration + ' min' : (duration/60) + ' hour' + (duration > 60 ? 's' : '')}</div>
            `).join('');

            const actContainer = document.getElementById('activity-selector');
            if (!actContainer) return;
            actContainer.innerHTML = timeActivities.map(activity => `<div class="activity-option" onclick="selectActivity('${escapeHtml(activity)}'); event.stopPropagation();">${escapeHtml(activity)}</div>`).join('');
        }
        function selectDurationFromElement(e) {
            e.stopPropagation();
            const el = e.currentTarget || e.target;
            const minutes = parseInt(el.dataset.duration, 10);
            selectedDuration = minutes;
            document.querySelectorAll('.duration-option').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
            checkTimerReady();
        }
        function selectActivity(activity) {
            selectedActivity = activity;
            document.querySelectorAll('.activity-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.activity-option').forEach(el => { if (el.textContent.includes(activity)) el.classList.add('selected'); });
            checkTimerReady();
        }
        function checkTimerReady() { const createBtn = document.getElementById('create-time-btn'); if (createBtn) createBtn.disabled = !(selectedDuration && selectedActivity); }

        function createTimeEvent() {
            if (!selectedDuration || !selectedActivity) return;
            const entry = { id: Date.now(), timestamp: new Date().toISOString(), note: `${selectedActivity} - ${selectedDuration} minutes`, location: '', weather: '', images: [], audio: null, coords: null, mood: null, activity: selectedActivity, duration: selectedDuration, isTimedActivity: true };
            entries.unshift(entry); saveData(); renderTimeline(); alert('‚úÖ Time event created!'); toggleTimer();
        }

        function resetTimerSelections() { selectedDuration = null; selectedActivity = null; document.querySelectorAll('.duration-option').forEach(el => el.classList.remove('selected')); document.querySelectorAll('.activity-option').forEach(el => el.classList.remove('selected')); const btn = document.getElementById('create-time-btn'); if (btn) btn.disabled = true; }

        function quickTrack(activity) { const entry = { id: Date.now(), timestamp: new Date().toISOString(), note: activity, location: '', weather: '', images: [], audio: null, coords: null, mood: null, isQuickTrack: true }; entries.unshift(entry); saveData(); renderTimeline(); toggleTrack(); alert(`‚úÖ Tracked: ${activity}`); }

        function saveSpent() {
            const description = document.getElementById('spent-description').value.trim();
            const amount = parseFloat(document.getElementById('spent-amount').value);
            if (!description) { alert('Please enter a description'); return; }
            if (!amount || amount <= 0) { alert('Please enter a valid amount'); return; }
            const entry = { id: Date.now(), timestamp: new Date().toISOString(), note: description, location: '', weather: '', images: [], audio: null, coords: null, mood: null, spentAmount: amount, isSpent: true };
            entries.unshift(entry); saveData(); renderTimeline(); toggleSpent(); alert(`‚úÖ Spent tracked: ‚Ç¨${amount.toFixed(2)}`);
        }

        // ----------------- Export helpers -----------------
        function exportCSV() {
            const headers = ['Date and Time', 'Note', 'Activity', 'Duration (min)', 'Location', 'Weather', 'Mood', 'Spent', 'Images'];
            const rows = entries.map(e => [new Date(e.timestamp).toLocaleString(), e.note, e.activity || '', e.duration || '', e.location || '', e.weather || '', e.mood ? `${e.mood.emoji} ${e.mood.label}` : '', e.spentAmount ? `‚Ç¨${e.spentAmount}` : '', e.images ? e.images.length : 0]);
            const csv = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `breadcrumbs-${Date.now()}.csv`; a.click();
        }

        function exportICS() {
            const icsEvents = entries.map(e => { const date = new Date(e.timestamp); const dateStr = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'; return `BEGIN:VEVENT\nUID:${e.id}@breadcrumbs\nDTSTAMP:${dateStr}\nDTSTART:${dateStr}\nSUMMARY:${escapeHtml(e.note).substring(0,50)}\nDESCRIPTION:${escapeHtml(e.note)}\nLOCATION:${escapeHtml(e.location || '')}\nEND:VEVENT`; }).join('\n');
            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Breadcrumbs Timeline//ES\n${icsEvents}\nEND:VCALENDAR`;
            const blob = new Blob([ics], { type: 'text/calendar' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `breadcrumbs-${Date.now()}.ics`; a.click();
        }

        // ----------------- Initial boot sequence -----------------
        // Load settings and local data first so UI is consistent whether offline or online
        loadSettings();
        loadMoodConfig();
        loadData();
        // update UI driven options
        updateTimerOptions();
        updateTrackOptions();

    </script>
</body>
</html>
